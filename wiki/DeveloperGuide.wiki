#summary agispeedy guide
#labels Featured,Phase-Implementation
#sidebar DeveloperGuide_sidebar

= DeveloperGuide =

== Installation ==

agispeedy compitable with linux system and asterisk.
cloud listen on 4573 (FastAGI port in asterisk).
your need install PHP >= 5.1.6

now!

frist download agispeedy source tarball.

copying files:
{{{
> tar zxvf agispeedy.X.X.tar.gz
> cp -rf agispeedy/ /
> cd /agispeedy/
> chmod +x bin/*
}}}

== Setup ==

=== Frist_time ===
folder struction:
{{{
agiscripts/	<--- save your agi scripts for agispeedy
bin/	<--- agispeedy main server
contrib/	<-- init script for centos
etc/	<--- agispeedy.conf here
}}}

try to startup agispeedy by manual:
{{{
cd /agispeedy/bin/
./agispeedy.php --debug

output:
[1330340963,4842][NOTICE]: Agispeedy - AGI ApplicationServer 0.8 starting...
[1330340964,4842][NOTICE][socket_open]: Services on 0.0.0.0:4573
[1330340964,4844][NOTICE][server_children_work]: children created!
[1330340964,4845][NOTICE][server_children_work]: children created!
[1330340964,4846][NOTICE][server_children_work]: children created!
[1330340965,4847][NOTICE][server_children_work]: children created!
[1330340965,4848][NOTICE][server_children_work]: children created!
[1330340965,4849][NOTICE][server_children_work]: children created!
[1330340965,4850][NOTICE][server_children_work]: children created!
[1330340965,4851][NOTICE][server_children_work]: children created!
}}}

=== configure ===

==== agispeedy.conf ====
edit /agispeedy/etc/agispeedy.conf to change configure:
{{{

[general]
agiscripts_path=/agispeedy/agiscripts/     <--- where is your agiscripts to change
pidfile_path=/var/run/    <--- pid file path, need write and read permission

// daemon settings
[daemon]
host=0.0.0.0    <--- accept ip 0.0.0.0 from all, 127.0.0.1 only local
port=4573       <--- FastAGI is 4573
mem_idle_size=1024    <--- idle record in size, please don't change
mem_forkchld_size=32768    <--- fork children in size, please don't change
max_children_lifesec=300   <--- max children execution time limits in sec
max_connections=2048    <--- max connections limits, 8 to 4096
max_idle_servers=8    <--- max perfork idle clone, 2 to 64

}}}

==== open files ====
enable change your need restart agispeedy services.
in most linux 'open files' is limited in poor value, "ulimit -a" to see,
to change this value, edit: /etc/security/limits.conf

append end of :
{{{
* soft nofile 32768
* hard nofile 65536
}}}

save and reboot your system.

==== database ====
agispeedy not support mysql_pconnect, agi connect database in each request.
if your need fast database connect you can use hook functions to make connect at children creating.

and don't forget add your database max connection limits.


==== commandline ====
run agispeedy in command:
{{{

> /agispeedy/bin/agispeedy.php

AGISPEEDY-PHP version 0.8
Author: Sun bing <hoowa.sun@gmail.com>
This is free software, and you are welcome to modify and redistribute it
under the GPL version 2 license.
This software comes with ABSOLUTELY NO WARRANTY.

Usage: ./agispeedy.php [option]
  --debug       Display more messages on screen.
  --quiet       Service as background.
  --log         Quiet and Write ERROR/WARNNING into '/tmp/agispeedy.log'.
  --logfull     Quiet and Write all messages into '/tmp/agispeedy.log'.
}}}

four options:
  * debug - output all messages and service frontground.
  * quiet - services run as background.
  * log - services run as background and write ERROR/WARNNING into /tmp/agispeedy.log
  * logfull - services run as background and write all messages into /tmp/agispeedy.log


==== services ====
init.d scripts in /agispeedy/contrib/ support centos/redhat system.

{{{
> cp /agispeedy/contrib/agispeedy.init.centos /etc/init.d/agispeedy/
> chkconfig --add agispeedy
> chkconfig --list|grep agispeedy
agispeedy       0:off   1:off   2:on    3:on    4:on    5:on    6:off
}}}

just start services as:
{{{
/etc/init.d/agispeedy start
}}}

stop services as:
{{{
/etc/init.d/agispeedy stop
}}}

restart services as:
{{{
/etc/init.d/agispeedy restart
}}}

service under safe_agispeedy mode.

== Works ==

=== Asterisk ===
Yes, Asterisk extension syntax little different with normal AGI.

for example, your before extension:
{{{

[demo]
exten => 8888,1,AGI(demo.php,digits=123456)
exten => 8888,n,Hangup()

}}}

now new extension is:
{{{

[demo]
exten => 8888,1,AGI(agi://127.0.0.1/demo,digits=123456)
exten => 8888,n,Hangup()

}}}

and if your agispeedy in remote server, change 127.0.0.1 to that server ip.

=== Agiscripts ===

* each agispeedy scripts must put in /agispeedy/agiscripts/

* each scripts must name prefix agi_+scriptname+.php, example:
{{{
exten => 8888,1,AGI(agi://127.0.0.1/demo,digits=123456)
agispeedy call agi_demo.php in /agispeedy/agiscripts/.

exten => 8888,1,AGI(agi://127.0.0.1/router_internal,digits=123456)
agispeedy call agi_router_internal.php in /agispeedy/agiscripts/.

}}}

* each scripts has same entry function named agi_main().
{{{
agi_demo.php:

<?php
function agi_main()
{
    $CLIENT = &$GLOBALS['CLIENT'];  //current session variables
    $AGI_INPUT = $CLIENT['agi']['input'];   //agi enviroment variable
    $AGI_PARAMS = $CLIENT['agi']['params']; //agi params variable

    agi_answer();
    agi_say_digits($AGI_PARAMS['digits']);
    agi_hangup();

return(true);
}
?>

}}}

* you can change agiscripts in anytime without restart services.

so now, did you run your frist agispeedy scripts?



== CommandLine ==

commandline interface looks like mysql monitor.

in aql source folder:
{{{
chmod +x aqlcli.php
./aqlcli.php <config_base_path>
}}}

example:
{{{
./aqlcli.php /etc/asterisk/

Welcome to the AQL command line interface.  Commands end pass Enter key
Your AQL Library version : 1.0 ,   AQL_Confparser Version : 0.3

type 'help' for help.

AQLcli>select * from sip.conf
}}}

you will see output data


== Methods ==

=== $AQL->set(option,value) ===

set An options to AQL object.
  * basedir : [//path//] load config files on base directory, you must specify path before all query.
  * autocommit : [true|false] each query command auto commit, tune false to disable auto commit and manual call $aql——>commit(...) to do.
  * reloadwhensave : [true|false]
  * queryresult : [true|false]
  * comment_flags : [#|;] comment char in config files.


=== $AQL->query(expression) ===

Query AQL statements to config file and get results.

References with query language in detail please see *Query Language Interface Reference*

=== $AQL->commit($filename) ===

Commit all query command to AQL conf parser engine. System will call this function automatically, unless tune false to the option 'autucommit'.

{{{
# system step by step to run two query commands.
$AQL->set('autocommit','false');
$AQL->query("select * from sip.conf");
$AQL->query("delete from sip.conf where section='8001'");
$AQL->commit("sip.conf");
}}}

=== $AQL->commit_clean($filename) ===

Means clean all commit command. Users will not use this function until tune false to the option 'autocommit'



=== $AQL->get_error() ===

Return string including the last error messages from config parser engine.

=== $AQL->get_affected_rows() ===

Get the number of affected rows by the last AQL commands.


== Query-Language-Interface-Reference ==

=== BasicSyntax ===

  * each asterisk conf file name is SQL table name
  * each section name is SQL table's field "section" and its PRIMARY KEY and its static key in any results
  * when select each dupcopy key will auto-convert to single string separated by ","
  * more than one key 
  * duplication of key name in asterisk convert in AQL append with [N],example allow=g729 allow=g723 to allow allow[1], but the frist key not changed.
  * if unsection will assign sectionname '[unsection]', in query section = null equal section = '[unsection]'



=== Expressions ===

The AQL Query syntax can be summarized as follows:
{{{

query from config files:

  SELECT * FROM <config_file>
    [WHERE <condition> [AND <condition> ...]]
    [LIMIT [<offset>,]<count>]

edit keys :

  UPDATE <config_file> SET key=value[,key2=value2]
    [WHERE <condition> [AND <condition> ...]]
    [LIMIT [<offset>,]<count>]
    
add new key :

  ALTER TABLE <config_file> ADD key=value[,key2=value2...] [AFTER(keyname)|BEFORE(keyname)]
    [WHERE <condition> [AND <condition> ...]]
    [LIMIT [<offset>,]<count>]
    
delete key :

  ALTER TABLE <config_file> DROP key,[key2...]
    [WHERE <condition> [AND <condition> ...]]
    [LIMIT [<offset>,]<count>]

add new section and datas:

  INSERT INTO <config_file> SET key=value[,key2=value2]
  
delete section :

  DELETE FROM <config_file>
    [WHERE <condition> [AND <condition> ...]]
    [LIMIT [<offset>,]<count>]

use other path(like $aql->set('basedir',path)) :

  USE <path>
  
}}}

As with SQL, AQL keywords are case insensitive. but table-name and field and value are case sensitive.

=== Condition ===

Only key name "section =" can be supported, because "section" is unique in asterisk config files.

The optional WHERE clause filters the result set to those entities that meet one or more conditions. 
Each condition compares a property of the entity with a value using a comparison operator and multiple conditions are given with the AND keyword. AQL does not have an ""OR"" operator.
{{{
# query results from 8001 to 8004 extensions.
where section >= 8001 and section <= 8004
# query results from unsection in any files.
where section = ''
}}}

=== Operators ===

{{{
comparison digit : = != < > <= >=
match string :
like '%string'
like 'string%'
like '%string%'
}}}

Note: like '%string%' is very slowly.

=== Limit ===

An optional LIMIT clause causes the query to stop returning results after the first count entities. The LIMIT can also include an offset to skip that many results to find the first result to return. An optional OFFSET clause can specify an offset if no LIMIT clause is present.

{{{
limit 10
limit 10,10
}}}

== Function-Based-Interface-Reference ==

Function based interface inheriting **aql_confparser.php**. that advanced class, for the beginnger we suggest try to Query Language Interface.

=== get_version() ===

return the version of aql_confparser.php

=== get_database() ===

return the full data from database variable.

Note: database variable include all of config files.

=== get_config_array($filename) ===

return parsed conf from database.

=== get_commit_assign($filename) ===

return commit assigned list.

=== open_config_file($filename) ===

open config file from filename

Note: database variable include all of config files.

=== open_reload($filename) ===

try to reload and reparse config with filename.

=== save_config_file($filename) ===

do commited change and save to config file.

=== check_database_exists($filename) ===

checking database's filename exists, return true or false.

=== free_database() ===

set database variable null.

=== assign_append($section,$key,$value,$position=null,$match_key=null) ===

assign append data around with section name.

$position:
  * null : append to end of section, or before space line in section.
  * before : append before keyname must set 'match_keyname'
  * after : append after keyname must set 'match_keyname'


=== assign_delkey($section,$key) ===

assign delkey from section in config files.

=== assign_addsection($section,$datachunk) ===

add section with special name and data chunk.

=== assign_delsection($section) ===

drop section with section name.

= AUTHOR =

Sun bing <hoowa.sun@gmail.com>.